#coding:utf8

import pandas as pd
import matplotlib.pyplot as plt
import os
import re

# Source des données : https://www.data.gouv.fr/datasets/election-presidentielle-des-10-et-24-avril-2022-resultats-definitifs-du-1er-tour/
with open("./data/resultats-elections-presidentielles-2022-1er-tour.csv") as fichier:
    contenu = pd.read_csv(fichier)

# Question 5
contenu = pd.read_csv("./data/resultats-elections-presidentielles-2022-1er-tour.csv")
print(contenu)

# question 6
nb_lignes = len(contenu)
nb_colonnes = len(contenu.columns)

print("Nombre de lignes :", nb_lignes)
print("Nombre de colonnes :", nb_colonnes)

# Réponse Nombre de lignes : 107, Nombre de colonnes : 56

#Question 7
listedestypes=contenu.dtypes
print(listedestypes)

#Question 8
print(contenu.head(1))

#Question 9 : 438109 inscrits

#Question 10
liste_sommes = []

for colonne in contenu.columns:
    if contenu[colonne].dtype in ["int64", "float64"]:
        somme = contenu[colonne].sum()   
        somme = int(somme) if contenu[colonne].dtype == "int64" else float(somme)
        liste_sommes.append((colonne, somme))  
print(liste_sommes)

# Question n°11
os.makedirs("graphes", exist_ok=True)

for index, row in contenu.iterrows():
    departement = row['Libellé du département']
    inscrits = row['Inscrits']
    votants = row['Votants']

    categories = ['Inscrits', 'Votants']
    valeurs = [inscrits, votants]

    plt.figure(figsize=(6, 4))
    plt.bar(categories, valeurs, color=['blue', 'green'])
    plt.title(f'Département {departement}')
    plt.ylabel('Nombre de personnes')

    nom_propre = re.sub(r'[^\w\-]', '_', departement)
    graphes = f"diagramme_{nom_propre}.png"
    plt.savefig(graphes)
    plt.close()

    print(f"Graphique enregistré : {graphes}")

# Question 12
os.makedirs("graphes", exist_ok=True)

for index, row in contenu.iterrows():
    try:
        departement = row['Libellé du département']
        blancs = row['Blancs']
        nuls = row['Nuls']
        exprimes = row['Exprimés']
        abstentions = row['Abstentions']

        valeurs = [blancs, nuls, exprimes, abstentions]
        labels = ['Blancs', 'Nuls', 'Exprimés', 'Abstentions']
        couleurs = ['lightgray', 'red', 'green', 'orange']

        plt.figure(figsize=(6, 6))
        plt.pie(valeurs, labels=labels, colors=couleurs, autopct='%1.1f%%')
        plt.title(f"Répartition des votes - {departement}")

        nom_fichier = re.sub(r'[^\w\-]', '_', departement)
        chemin = f"graphes/diagramme_{nom_fichier}.png"
        plt.savefig(chemin)
        plt.close()

        print(f"✅ Camembert enregistré : {chemin}")
    
    except KeyError as e:
        print(f"❌ Colonne manquante pour la ligne {index} : {e}")

# Question 13
inscrits = contenu['Inscrits']

plt.figure(figsize=(8, 6))
plt.hist(inscrits, bins=20, color='skyblue', edgecolor='black')
plt.title("Distribution des inscrits")
plt.xlabel("Nombre d'inscrits")
plt.ylabel("Nombre de départements")
plt.grid(True)

os.makedirs("graphes", exist_ok=True)
plt.savefig("histogrammes/distribution_inscrits.png")

